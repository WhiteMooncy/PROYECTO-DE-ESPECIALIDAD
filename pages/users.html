<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Panel Administrativo | Hydro-Conecta</title>
    <meta name="description" content="Gestión y visualización de usuarios del sistema de encuestas">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/sources/img/icon/icon.webp">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Stylesheets Modulares -->
    <link rel="stylesheet" href="../assets/sources/css/variables.css">
    <link rel="stylesheet" href="../assets/sources/css/shared.css">
    <link rel="stylesheet" href="../assets/sources/css/admin.css">
</head>
<body>
    <!-- SVG Waves Background -->
    <div class="waves-background">
        <div class="wave wave-1">
            <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M0,50 Q150,100 300,50 T600,50 T900,50 T1200,50 L1200,120 L0,120 Z" fill="#0077b6"/>
            </svg>
        </div>
        <div class="wave wave-2">
            <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M0,70 Q200,20 400,70 T800,70 T1200,70 L1200,120 L0,120 Z" fill="#00b4d8"/>
            </svg>
        </div>
        <div class="wave wave-3">
            <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M0,30 Q250,80 500,30 T1000,30 T1500,30 L1500,120 L0,120 Z" fill="#48cae4"/>
            </svg>
        </div>
        <div class="wave wave-4">
            <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M0,90 Q300,40 600,90 T1200,90 L1200,120 L0,120 Z" fill="#90e0ef"/>
            </svg>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <nav class="navbar-modern">
        <div class="navbar-container">
            <a href="../index.html" class="navbar-brand">
                <i class="fas fa-water"></i>
                <span>Hydro-Conecta</span>
            </a>
            <button class="navbar-toggler" id="navbar-toggler" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="navbar-menu" id="navbar-menu">
                <a href="map.html" class="nav-link">
                    <i class="fas fa-map-marked-alt"></i>
                    Mapa
                </a>
                <a href="users.html" class="nav-link-login active">
                    <i class="fas fa-users"></i>
                    Usuarios
                </a>
                <a href="responses.html" class="nav-link">
                    <i class="fas fa-reply"></i>
                    Respuestas
                </a>
                <a href="dashboard.html" class="nav-link-login">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </nav>
    
    <main class="main-content" role="main">
        <!-- Sección: Usuarios -->
        <section id="users-section" class="section active">
    
    <!-- KPI Stats Cards -->
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-value" id="total-users">8</span>
                <span class="kpi-label">Total Usuarios</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-value" id="active-users">6</span>
                <span class="kpi-label">Activos</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">
                <i class="fas fa-user-clock"></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-value" id="pending-users">2</span>
                <span class="kpi-label">Pendientes</span>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-value" id="total-comments">24</span>
                <span class="kpi-label">Comentarios</span>
            </div>
        </div>
    </div>

    <div class="section-header">
        <div class="header-left">
            <h2><i class="fas fa-users-cog"></i> Gestión de Usuarios</h2>
            <p>Lista completa de usuarios, incluyendo datos de contacto y comentarios recientes.</p>
        </div>
        <div class="header-actions">
            <button class="action-btn" id="search-toggle" title="Buscar usuario">
                <i class="fas fa-search"></i>
            </button>
            <button class="action-btn" id="filter-toggle" title="Filtrar">
                <i class="fas fa-filter"></i>
            </button>
            <button class="action-btn" id="export-users-btn" title="Exportar usuarios">
                <i class="fas fa-file-export"></i>
            </button>
            <button class="action-btn" id="add-user-btn" title="Agregar usuario">
                <i class="fas fa-user-plus"></i>
            </button>
        </div>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="search-panel" style="display: none;">
        <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="user-search" placeholder="Buscar por nombre, email o RUT..." autocomplete="off">
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filter-panel" style="display: none;">
        <h3><i class="fas fa-sliders-h"></i> Filtros</h3>
        <div class="filter-group">
            <label><i class="fas fa-toggle-on"></i> Estado</label>
            <select id="status-filter">
                <option value="all">Todos los estados</option>
                <option value="active">Activos</option>
                <option value="pending">Pendientes</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-sort-alpha-down"></i> Ordenar por</label>
            <select id="sort-filter">
                <option value="name">Nombre (A-Z)</option>
                <option value="name-desc">Nombre (Z-A)</option>
                <option value="recent">Más recientes</option>
                <option value="comments">Más comentarios</option>
            </select>
        </div>
        <button class="apply-filters-btn" id="apply-user-filters">
            Aplicar Filtros <i class="fas fa-check"></i>
        </button>
    </div>

    <div class="users-table">
        
        <div class="table-header">
            <div>Usuario</div>
            <div>RUT</div>
            <div>Comentario Reciente</div>
            <div>Estado</div>
        </div>

        <div class="table-row">
            
            <div class="user-info" data-label="Usuario">
                <div class="user-avatar">AD</div>
                <div>
                    <div style="font-weight: 600;">Alejandra Díaz</div>
                    <small style="color: rgba(255, 255, 255, 0.5);">alejandra@mail.com</small>
                </div>
            </div>

            <div data-label="RUT">
                18.765.432-1
            </div>
            
            <div data-label="Comentario Reciente" style="opacity: 0.8; font-style: italic;">
                "El dashboard está mucho más limpio después de la actualización."
            </div>
            
            <div data-label="Estado">
                <span class="badge badge-active">Activo</span>
            </div>
        </div>

        <div class="table-row">
            <div class="user-info" data-label="Usuario">
                <div class="user-avatar" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">RM</div>
                <div>
                    <div style="font-weight: 600;">Ricardo Montero</div>
                    <small style="color: rgba(255, 255, 255, 0.5);">ricardo@mail.com</small>
                </div>
            </div>
            <div data-label="RUT">
                19.234.567-K
            </div>
            <div data-label="Comentario Reciente" style="opacity: 0.8; font-style: italic;">
                "Tuve problemas al filtrar los datos de la semana pasada."
            </div>
            <div data-label="Estado">
                <span class="badge" style="background: rgba(231, 76, 60, 0.1); color: #e74c3c;">Suspendido</span>
            </div>
        </div>

        <div class="table-row">
            <div class="user-info" data-label="Usuario">
                <div class="user-avatar" style="background: linear-gradient(135deg, #f1c40f, #f39c12);">SL</div>
                <div>
                    <div style="font-weight: 600;">Sofía López</div>
                    <small style="color: rgba(255, 255, 255, 0.5);">sofia@mail.com</small>
                </div>
            </div>
            <div data-label="RUT">
                17.890.123-5
            </div>
            <div data-label="Comentario Reciente" style="opacity: 0.8; font-style: italic;">
                "No hay comentarios recientes."
            </div>
            <div data-label="Estado">
                <span class="badge badge-active">Activo</span>
            </div>
        </div>

    </div>
</section>

    </main>
    <!-- Footer se carga dinámicamente -->
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="../assets/sources/js/auth.js"></script>
    <script src="../assets/sources/js/dashboard.js?v=2"></script>
    <script src="../assets/sources/js/admin-footer.js"></script>
    
    <script>
        // Navbar Toggle
        const navbarToggler = document.getElementById('navbar-toggler');
        const navbarMenu = document.getElementById('navbar-menu');
        
        if(navbarToggler){
            navbarToggler.addEventListener('click', () => {
                navbarMenu.classList.toggle('active');
                navbarToggler.classList.toggle('active');
            });
        }

        // Search Toggle
        const searchToggle = document.getElementById('search-toggle');
        const searchPanel = document.getElementById('search-panel');
        const filterToggle = document.getElementById('filter-toggle');
        const filterPanel = document.getElementById('filter-panel');

        if(searchToggle && searchPanel) {
            searchToggle.addEventListener('click', () => {
                const isVisible = searchPanel.style.display !== 'none';
                searchPanel.style.display = isVisible ? 'none' : 'block';
                searchToggle.classList.toggle('active');
                
                if (!isVisible && filterPanel) {
                    filterPanel.style.display = 'none';
                    if(filterToggle) filterToggle.classList.remove('active');
                }
            });
        }

        if(filterToggle && filterPanel) {
            filterToggle.addEventListener('click', () => {
                const isVisible = filterPanel.style.display !== 'none';
                filterPanel.style.display = isVisible ? 'none' : 'block';
                filterToggle.classList.toggle('active');
                
                if (!isVisible && searchPanel) {
                    searchPanel.style.display = 'none';
                    if(searchToggle) searchToggle.classList.remove('active');
                }
            });
        }

        // Search Functionality
        const userSearch = document.getElementById('user-search');
        if(userSearch) {
            userSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const tableRows = document.querySelectorAll('.users-table .table-row');
                
                tableRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Filter Functionality
        const applyFilters = document.getElementById('apply-user-filters');
        if(applyFilters) {
            applyFilters.addEventListener('click', () => {
                const statusFilter = document.getElementById('status-filter').value;
                const sortFilter = document.getElementById('sort-filter').value;
                const tableRows = Array.from(document.querySelectorAll('.users-table .table-row'));
                
                // Filter by status
                tableRows.forEach(row => {
                    if(statusFilter === 'all') {
                        row.style.display = '';
                    } else {
                        const statusBadge = row.querySelector('.status-badge');
                        const isActive = statusBadge && statusBadge.textContent.toLowerCase().includes('activo');
                        
                        if(statusFilter === 'active' && isActive) {
                            row.style.display = '';
                        } else if(statusFilter === 'pending' && !isActive) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });

                // Sort
                const container = document.querySelector('.users-table');
                const header = container.querySelector('.table-header');
                
                if(sortFilter === 'name') {
                    tableRows.sort((a, b) => {
                        const nameA = a.querySelector('.user-info div div').textContent;
                        const nameB = b.querySelector('.user-info div div').textContent;
                        return nameA.localeCompare(nameB);
                    });
                } else if(sortFilter === 'name-desc') {
                    tableRows.sort((a, b) => {
                        const nameA = a.querySelector('.user-info div div').textContent;
                        const nameB = b.querySelector('.user-info div div').textContent;
                        return nameB.localeCompare(nameA);
                    });
                }
                
                tableRows.forEach(row => container.appendChild(row));
                
                alert('Filtros aplicados correctamente');
            });
        }

        // Export Users
        const exportBtn = document.getElementById('export-users-btn');
        if(exportBtn) {
            exportBtn.addEventListener('click', () => {
                const users = [];
                const tableRows = document.querySelectorAll('.users-table .table-row');
                
                tableRows.forEach(row => {
                    const userName = row.querySelector('.user-info div div').textContent;
                    const userEmail = row.querySelector('.user-info small').textContent;
                    const rut = row.querySelectorAll('[data-label="RUT"]')[0]?.textContent.trim();
                    const status = row.querySelector('.status-badge')?.textContent.trim();
                    
                    users.push({
                        nombre: userName,
                        email: userEmail,
                        rut: rut,
                        estado: status
                    });
                });

                const data = {
                    usuarios: users,
                    total: users.length,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'hydro-conecta-usuarios-' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('¡Usuarios exportados exitosamente!');
            });
        }

        // Add User Button
        const addUserBtn = document.getElementById('add-user-btn');
        if(addUserBtn) {
            addUserBtn.addEventListener('click', () => {
                alert('Funcionalidad de agregar usuario en desarrollo');
            });
        }

        // Animate KPI values on load
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            if (!element) return;
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    element.textContent = Math.round(end);
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        // Animate KPIs on load
        window.addEventListener('load', () => {
            animateValue('total-users', 0, 8, 1000);
            animateValue('active-users', 0, 6, 1200);
            animateValue('pending-users', 0, 2, 800);
            animateValue('total-comments', 0, 24, 1500);
        });
    </script>
    
    <!-- Auth System -->
    <script src="../assets/sources/js/auth.js"></script>
    <script>
        const auth = new AuthManager();
        auth.initDashboard();
    </script>
</body>
</html>