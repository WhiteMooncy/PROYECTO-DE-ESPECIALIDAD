name: CI/CD y Notificación a Discord

# Ejecutar en cualquier rama, PR y manualmente
on:
  push:           # escucha pushes en cualquier rama
  pull_request:   # escucha PRs hacia cualquier rama
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Notificación de estado a Discord
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }} 

          status: ${{ job.status }}
          title: "Estado del Despliegue de PROYECTO-DE-ESPECIALIDAD"

          description: |
            ✅ **Flujo Finalizado: ${{ job.status }}**

            👤 **Autor:** ${{ github.actor }}
            📝 **Mensaje del commit / PR:**
            > ${{ github.event.head_commit.message || github.event.pull_request.title || 'N/A' }}

            🔗 **Ver commit/PR:** ${{ github.event.pull_request.html_url || format('https://github.com/{0}/commit/{1}', github.repository, github.sha) }}

          url: "https://github.com/${{ github.repository }}"
          username: "GitHub CI/CD Bot"
          # color según resultado (verde/rojo)
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}

          content: "El flujo de trabajo CI/CD ha finalizado con el estado: **${{ job.status }}**."

      - name: Enviar embed con imagen (adjunta desde workspace)
        if: always()
        run: |
          # exportar variables de contexto para usarlas dentro del payload
          export JOB_STATUS="${{ job.status }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export GITHUB_REF="${{ github.ref }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          export GITHUB_WORKFLOW="${{ github.workflow }}"

          # construir payload JSON (variables se expanden gracias al heredoc sin comillas)
          payload=$(cat <<EOF
          {
            "username": "GitHub Actions",
            "embeds": [
              {
                "title": "Estado: ${JOB_STATUS}",
                "description": "Repositorio: ${GITHUB_REPOSITORY}\nRef: ${GITHUB_REF}\nAutor: ${GITHUB_ACTOR}",
                "color": ${JOB_STATUS:-"\"65280\""},
                "image": { "url": "attachment://veggeta.webp" },
                "footer": { "text": "Job: deploy • ${GITHUB_WORKFLOW}" }
              }
            ]
          }
          EOF
          )

          # Enviar via webhook adjuntando el archivo desde el workspace
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -F "payload_json=$payload" \
            -F "file=@assets/sources/img/veggeta.webp;filename=veggeta.webp"
