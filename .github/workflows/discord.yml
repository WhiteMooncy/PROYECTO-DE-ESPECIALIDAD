name: CI/CD y Notificación a Discord

# Ejecutar en cualquier rama, PR y manualmente
on:
  push:           # escucha pushes en cualquier rama
  pull_request:   # escucha PRs hacia cualquier rama
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Notificación de estado a Discord
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }} 

          status: ${{ job.status }}
          title: "Estado del Despliegue de PROYECTO-DE-ESPECIALIDAD"

          description: |
            ✅ **Flujo Finalizado: ${{ job.status }}**

            👤 **Autor:** ${{ github.actor }}
            📝 **Mensaje del commit / PR:**
            > ${{ github.event.head_commit.message || github.event.pull_request.title || 'N/A' }}

            🔗 **Ver commit/PR:** ${{ github.event.pull_request.html_url || format('https://github.com/{0}/commit/{1}', github.repository, github.sha) }}

          url: "https://github.com/${{ github.repository }}"
          username: "GitHub CI/CD Bot"
          # color según resultado (verde/rojo)
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}

          content: "El flujo de trabajo CI/CD ha finalizado con el estado: **${{ job.status }}**."

      - name: Enviar embed con imagen (Discord webhook)
        if: always()
        run: |
          curl -H "Content-Type: application/json" -d @- "${{ secrets.DISCORD_WEBHOOK }}" <<JSON
          {
            "username": "GitHub Actions",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [
              {
                "title": "Estado: ${{ job.status }}",
                "description": "Repositorio: ${{ github.repository }}\nRef: ${{ github.ref }}\nAutor: ${{ github.actor }}",
                "color": 65280,
                "image": {
                  "url": "https://raw.githubusercontent.com/miusuario/PROYECTO-DE-ESPECIALIDAD/main/assets/img/veggeta.webp"
                },
                "footer": {
                  "text": "Job: deploy • ${{ github.workflow }}"
                }
              }
            ]
          }
          JSON
