// Datos de ejemplo mejorados
const surveyData = {
    questions: [
        { label: 'Pregunta 1', value: 85, responses: 1060 },
        { label: 'Pregunta 2', value: 72, responses: 898 },
        { label: 'Pregunta 3', value: 91, responses: 1135 },
        { label: 'Pregunta 4', value: 68, responses: 848 },
        { label: 'Pregunta 5', value: 79, responses: 985 }
    ],
    categories: [
        { label: 'Satisfacción', value: 92 },
        { label: 'Calidad', value: 88 },
        { label: 'Precio', value: 75 },
        { label: 'Servicio', value: 94 }
    ],
    users: [
        { name: 'María González', location: 'Santiago, Chile', date: '2025-10-27 14:30', lat: -33.4489, lng: -70.6693, region: 'Metropolitana' },
        { name: 'Carlos Rodríguez', location: 'Valparaíso, Chile', date: '2025-10-27 10:15', lat: -33.0472, lng: -71.6127, region: 'Valparaíso' },
        { name: 'Ana Martínez', location: 'Concepción, Chile', date: '2025-10-26 16:45', lat: -36.8201, lng: -73.0444, region: 'Biobío' },
        { name: 'Juan Pérez', location: 'La Serena, Chile', date: '2025-10-26 09:20', lat: -29.9027, lng: -71.2519, region: 'Coquimbo' },
        { name: 'Sofía López', location: 'Antofagasta, Chile', date: '2025-10-25 13:55', lat: -23.6509, lng: -70.3975, region: 'Antofagasta' },
        { name: 'Diego Silva', location: 'Temuco, Chile', date: '2025-10-25 11:30', lat: -38.7359, lng: -72.5904, region: 'Araucanía' },
        { name: 'Laura Torres', location: 'Rancagua, Chile', date: '2025-10-24 15:10', lat: -34.1705, lng: -70.7407, region: "O'Higgins" },
        { name: 'Roberto Muñoz', location: 'Puerto Montt, Chile', date: '2025-10-24 08:45', lat: -41.4693, lng: -72.9424, region: 'Los Lagos' }
    ],
    locations: [
        { city: 'Santiago', lat: -33.4489, lng: -70.6693, percentage: 45, surveys: 450, region: 'Metropolitana' },
        { city: 'Valparaíso', lat: -33.0472, lng: -71.6127, percentage: 15, surveys: 150, region: 'Valparaíso' },
        { city: 'Concepción', lat: -36.8201, lng: -73.0444, percentage: 12, surveys: 120, region: 'Biobío' },
        { city: 'La Serena', lat: -29.9027, lng: -71.2519, percentage: 8, surveys: 80, region: 'Coquimbo' },
        { city: 'Antofagasta', lat: -23.6509, lng: -70.3975, percentage: 7, surveys: 70, region: 'Antofagasta' },
        { city: 'Temuco', lat: -38.7359, lng: -72.5904, percentage: 6, surveys: 60, region: 'Araucanía' },
        { city: 'Rancagua', lat: -34.1705, lng: -70.7407, percentage: 4, surveys: 40, region: "O'Higgins" },
        { city: 'Puerto Montt', lat: -41.4693, lng: -72.9424, percentage: 3, surveys: 30, region: 'Los Lagos' }
    ]
};

// Variables globales
let map;
let mapInitialized = false;
let markerClusterGroup;
let currentMarkers = [];
let isFullscreen = false;

// Inicialización cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('map')) {
        initMap();
        initKPIs();
        initControls();
        initSearch();
        initFilters();
    }
});

// Inicializar KPIs
function initKPIs() {
    const totalLocations = surveyData.locations.length;
    const totalSurveys = surveyData.locations.reduce((sum, loc) => sum + loc.surveys, 0);
    const totalRegions = new Set(surveyData.locations.map(loc => loc.region)).size;
    
    // Animar contadores
    animateValue('total-locations', 0, totalLocations, 1000);
    animateValue('total-surveys', 0, totalSurveys, 1500);
    animateValue('total-regions', 0, totalRegions, 800);
}

// Función para animar valores numéricos
function animateValue(id, start, end, duration) {
    const element = document.getElementById(id);
    if (!element) return;
    
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= end) {
            element.textContent = Math.round(end);
            clearInterval(timer);
        } else {
            element.textContent = Math.round(current);
        }
    }, 16);
}

// Inicializar mapa
function initMap() {
    const mapElement = document.getElementById('map');
    const loadingElement = document.getElementById('map-loading');
    
    if (!mapElement) return;
    
    // Simular carga
    setTimeout(() => {
        // Crear el mapa centrado en Chile
        map = L.map('map').setView([-33.4489, -70.6693], 5);
        
        // Añadir capa de tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Inicializar cluster group
        markerClusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false,
            maxClusterRadius: 50
        });
        
        // Agregar marcadores
        addMarkers();
        
        map.addLayer(markerClusterGroup);
        mapInitialized = true;
        
        // Ocultar loading
        if (loadingElement) {
            loadingElement.classList.add('hidden');
        }
    }, 1500);
}

// Agregar marcadores al mapa
function addMarkers() {
    currentMarkers = [];
    markerClusterGroup.clearLayers();
    
    surveyData.locations.forEach(location => {
        // Determinar color según porcentaje
        let color = '#90e0ef'; // Baja
        if (location.percentage > 30) color = '#0077b6'; // Alta
        else if (location.percentage > 10) color = '#00b4d8'; // Media
        
        // Crear icono personalizado
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                background: ${color};
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 12px;
            ">${location.percentage}%</div>`,
            iconSize: [30, 30]
        });
        
        const marker = L.marker([location.lat, location.lng], { icon: customIcon });
        
        // Popup content
        marker.bindPopup(`
            <div style="min-width: 200px;">
                <h3 style="margin: 0 0 0.5rem; color: #0077b6; font-size: 1.1rem;">${location.city}</h3>
                <p style="margin: 0.25rem 0;"><strong>Región:</strong> ${location.region}</p>
                <p style="margin: 0.25rem 0;"><strong>Encuestas:</strong> ${location.surveys}</p>
                <p style="margin: 0.25rem 0;"><strong>Participación:</strong> ${location.percentage}%</p>
            </div>
        `);
        
        // Evento click para mostrar panel de información
        marker.on('click', () => showInfoPanel(location));
        
        markerClusterGroup.addLayer(marker);
        currentMarkers.push({ marker, location });
    });
}

// Mostrar panel de información lateral
function showInfoPanel(location) {
    const panel = document.getElementById('info-panel');
    const content = document.getElementById('info-panel-content');
    
    if (!panel || !content) return;
    
    content.innerHTML = `
        <h3><i class="fas fa-map-marker-alt" style="color: #0077b6;"></i> ${location.city}</h3>
        
        <div class="info-detail">
            <div class="info-detail-label">Región</div>
            <div class="info-detail-value">${location.region}</div>
        </div>
        
        <div class="info-detail">
            <div class="info-detail-label">Total de Encuestas</div>
            <div class="info-detail-value">${location.surveys}</div>
        </div>
        
        <div class="info-detail">
            <div class="info-detail-label">Participación</div>
            <div class="info-detail-value">${location.percentage}%</div>
        </div>
        
        <div class="info-detail">
            <div class="info-detail-label">Coordenadas</div>
            <div class="info-detail-value">${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</div>
        </div>
        
        <div class="info-chart">
            <h4 style="margin-bottom: 0.5rem; color: #03045e;">Distribución</h4>
            <div style="background: rgba(0, 119, 182, 0.1); height: 20px; border-radius: 10px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #0077b6, #00b4d8); height: 100%; width: ${location.percentage}%; transition: width 0.5s;"></div>
            </div>
        </div>
    `;
    
    panel.classList.add('open');
}

// Inicializar controles
function initControls() {
    // Toggle búsqueda
    const searchToggle = document.getElementById('search-toggle');
    const searchPanel = document.getElementById('search-panel');
    
    if (searchToggle && searchPanel) {
        searchToggle.addEventListener('click', () => {
            const isVisible = searchPanel.style.display !== 'none';
            searchPanel.style.display = isVisible ? 'none' : 'block';
            searchToggle.classList.toggle('active');
            
            // Cerrar otros paneles
            if (!isVisible) {
                document.getElementById('filter-panel').style.display = 'none';
                document.getElementById('filter-toggle').classList.remove('active');
            }
        });
    }
    
    // Toggle filtros
    const filterToggle = document.getElementById('filter-toggle');
    const filterPanel = document.getElementById('filter-panel');
    
    if (filterToggle && filterPanel) {
        filterToggle.addEventListener('click', () => {
            const isVisible = filterPanel.style.display !== 'none';
            filterPanel.style.display = isVisible ? 'none' : 'block';
            filterToggle.classList.toggle('active');
            
            // Cerrar otros paneles
            if (!isVisible) {
                searchPanel.style.display = 'none';
                searchToggle.classList.remove('active');
            }
        });
    }
    
    // Toggle leyenda
    const legendToggle = document.getElementById('legend-toggle');
    const legendPanel = document.getElementById('legend-panel');
    
    if (legendToggle && legendPanel) {
        legendToggle.addEventListener('click', () => {
            const isVisible = legendPanel.style.display !== 'none';
            legendPanel.style.display = isVisible ? 'none' : 'block';
            legendToggle.classList.toggle('active');
        });
    }
    
    // Botón exportar
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportData);
    }
    
    // Botón pantalla completa
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
    }
    
    // Cerrar panel de información
    const closeInfoPanel = document.getElementById('close-info-panel');
    if (closeInfoPanel) {
        closeInfoPanel.addEventListener('click', () => {
            document.getElementById('info-panel').classList.remove('open');
        });
    }
}

// Inicializar búsqueda
function initSearch() {
    const searchInput = document.getElementById('location-search');
    const searchResults = document.getElementById('search-results');
    
    if (!searchInput || !searchResults) return;
    
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }
        
        const results = surveyData.locations.filter(loc => 
            loc.city.toLowerCase().includes(query) || 
            loc.region.toLowerCase().includes(query)
        );
        
        searchResults.innerHTML = results.map(loc => `
            <div class="search-result-item" data-lat="${loc.lat}" data-lng="${loc.lng}">
                <i class="fas fa-map-marker-alt"></i>
                <span>${loc.city}, ${loc.region}</span>
            </div>
        `).join('');
        
        // Agregar eventos a resultados
        searchResults.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                map.setView([lat, lng], 10);
                searchInput.value = '';
                searchResults.innerHTML = '';
            });
        });
    });
}

// Inicializar filtros
function initFilters() {
    // Poblar select de regiones
    const regionFilter = document.getElementById('region-filter');
    if (regionFilter) {
        const regions = [...new Set(surveyData.locations.map(loc => loc.region))];
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionFilter.appendChild(option);
        });
    }
    
    // Aplicar filtros
    const applyFiltersBtn = document.getElementById('apply-filters');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyFilters);
    }
}

// Aplicar filtros
function applyFilters() {
    const dateFilter = document.getElementById('date-filter').value;
    const regionFilter = document.getElementById('region-filter').value;
    const showMarkers = document.getElementById('show-markers').checked;
    
    // Filtrar y actualizar marcadores
    markerClusterGroup.clearLayers();
    
    let filteredLocations = surveyData.locations;
    
    if (regionFilter !== 'all') {
        filteredLocations = filteredLocations.filter(loc => loc.region === regionFilter);
    }
    
    if (showMarkers) {
        filteredLocations.forEach(location => {
            const marker = currentMarkers.find(m => m.location.city === location.city);
            if (marker) {
                markerClusterGroup.addLayer(marker.marker);
            }
        });
    }
    
    console.log(`Filtros aplicados: ${filteredLocations.length} ubicaciones mostradas`);
}

// Exportar datos
function exportData() {
    const data = {
        locations: surveyData.locations,
        totalSurveys: surveyData.locations.reduce((sum, loc) => sum + loc.surveys, 0),
        exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hydro-conecta-map-data-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('¡Datos exportados exitosamente!');
}

// Toggle pantalla completa
function toggleFullscreen() {
    const mapSection = document.getElementById('map-section');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const icon = fullscreenBtn.querySelector('i');
    
    if (!isFullscreen) {
        mapSection.classList.add('fullscreen-mode');
        icon.classList.remove('fa-expand');
        icon.classList.add('fa-compress');
        isFullscreen = true;
        
        // Reajustar mapa
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 100);
    } else {
        mapSection.classList.remove('fullscreen-mode');
        icon.classList.remove('fa-compress');
        icon.classList.add('fa-expand');
        isFullscreen = false;
        
        // Reajustar mapa
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 100);
    }
}
 
    // renderBarChart('barChart', surveyData.questions);
    // renderBarChart('categoryChart', surveyData.categories);
    // renderUsersTable(); 
});

// **FUNCIÓN initNavigation ORIGINALMENTE EN TU CÓDIGO**
// La he dejado comentada por si la usas en la página principal del dashboard
/*
function initNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const sectionId = item.dataset.section;
            
            // Actualizar navegación activa
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            // Actualizar secciones activas
            sections.forEach(section => section.classList.remove('active'));
            
            // Mostrar sección correspondiente
            switch(sectionId) {
                case 'results':
                    document.getElementById('results').classList.add('active');
                    break;
                case 'map':
                    document.getElementById('map-section').classList.add('active');
                    if (!mapInitialized) {
                        initMap();
                    }
                    break;
                case 'users':
                    document.getElementById('users-section').classList.add('active');
                    break;
            }
        });
    });
}
*/

// Renderizar gráficos de barras
function renderBarChart(containerId, data) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const maxValue = Math.max(...data.map(d => d.value));
    
    container.innerHTML = data.map(item => `
        <div class="bar-item">
            <div class="bar" style="height: ${(item.value / maxValue) * 100}%">
                <div class="bar-value">${item.value}%</div>
            </div>
            <div class="bar-label">${item.label}</div>
        </div>
    `).join('');
}

// Inicializar mapa con Leaflet
function initMap() {
    if (mapInitialized) return;
    
    const mapElement = document.getElementById('map');
    if (!mapElement) return;
    
    try {
        // Inicializar el mapa, centrado en Chile
        map = L.map('map').setView([-33.4489, -70.6693], 5);
        
        // Añadir el TileLayer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Añadir los círculos (marcadores)
        surveyData.locations.forEach(location => {
            // El radio ajustado a una escala más sensible para mejor visualización
            const radius = location.percentage * 2500; 
            
            const circle = L.circle([location.lat, location.lng], {
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.4,
                radius: radius
            }).addTo(map);

            // Calcular un valor total estimado para el popup
            const totalResponses = surveyData.users.length; // Usamos el número de usuarios como referencia
            const estimatedResponses = Math.round(totalResponses * location.percentage / 100);

            circle.bindPopup(`
                <strong>${location.city}</strong><br>
                Porcentaje de respuestas: ${location.percentage}%<br>
                Usuarios (Est.): ${estimatedResponses}
            `);
        });

        mapInitialized = true;
        
        // El invalidateSize ya no es tan crítico aquí, pero se mantiene como buena práctica
        // por si el contenedor 'map' tiene estilos CSS que lo afectan.
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    } catch (error) {
        console.error('Error inicializando el mapa:', error);
    }
}

// Renderizar tabla de usuarios
function renderUsersTable() {
    const tbody = document.getElementById('usersTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = surveyData.users.map(user => {
        const initials = user.name.split(' ').map(n => n[0]).join('');
        return `
            <div class="table-row">
                <div class="user-info">
                    <div class="user-avatar">${initials}</div>
                    <span>${user.name}</span>
                </div>
                <div>${user.location}</div>
                <div>${user.date}</div>
                <div><span class="badge badge-active">Completado</span></div>
            </div>
        `;
    }).join('');
}